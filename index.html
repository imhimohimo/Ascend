<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redirecting…</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; }
    code { background:#f5f5f5; padding:2px 6px; border-radius:4px; }
  </style>
</head>
<body>
  <h1>Redirecting…</h1>
  <p>If nothing happens, <a id="fallbackLink" href="#">click here</a>.</p>
  <p style="opacity:.7">Tip: test with <code>?override=OPEN</code> or <code>?override=FULL</code>.</p>

<script>
// ====== CONFIG: EDIT THESE ======
const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSO7dKqt9Fst8f5EW3MH307osIhKeelEKhD54PZzGUUmCSi6jY7Psf_8jvu26DEBfNJwFlFsb7o9GFF/pub?gid=0&single=true&output=csv';
// If Overflow row is missing or CSV fails, use this:
const ABSOLUTE_DEFAULT_URL = 'https://tally.so/r/3qrGbG';
// ====== END CONFIG ======

// Sheet columns: SECTION | STATUS | PUBLIC_LINK | PRIVATE_LINK | CAP | COUNT | MANUAL_OVERRIDE
// Rows of interest:
const ROWS = {
  AUDIT: 'Audit',       // row 2
  WAITLIST: 'Waitlist', // row 3
  OVERFLOW: 'Overflow'  // row 4
};

(async function main() {
  log('--- Redirect flow started ---');

  // 1) URL override
  const urlOverride = getUrlParamOverride();
  if (urlOverride) {
    const dest = await resolveDestination(urlOverride);
    return redirect(dest, `URL override = ${urlOverride}`);
  }

  try {
    // 2) Read CSV and rows
    const rows = await fetchCsv(CSV_URL);
    const table = indexBySection(rows);

    const audit = table[ROWS.AUDIT];
    const waitlist = table[ROWS.WAITLIST];
    const overflow = table[ROWS.OVERFLOW];

    if (!audit) {
      warn('Audit row not found; using ABSOLUTE_DEFAULT_URL.');
      return redirect(ABSOLUTE_DEFAULT_URL, 'Audit row missing');
    }

    // Read MANUAL_OVERRIDE from Audit row
    const manual = (audit.MANUAL_OVERRIDE || '').toUpperCase().trim(); // AUTO | FORCED_OPEN | FORCED_CLOSED
    if (manual === 'FORCED_OPEN') {
      const dest = audit.PUBLIC_LINK || ABSOLUTE_DEFAULT_URL;
      return redirect(dest, 'MANUAL_OVERRIDE = FORCED_OPEN');
    }
    if (manual === 'FORCED_CLOSED') {
      const dest = (waitlist && waitlist.PUBLIC_LINK) || (overflow && overflow.PUBLIC_LINK) || ABSOLUTE_DEFAULT_URL;
      return redirect(dest, 'MANUAL_OVERRIDE = FORCED_CLOSED');
    }

    // 3) MANUAL_OVERRIDE is AUTO → use STATUS from Audit row
    const status = normalizeStatus(audit.STATUS); // OPEN | FULL | CLOSED | null
    if (status === 'OPEN') {
      const dest = audit.PUBLIC_LINK || ABSOLUTE_DEFAULT_URL;
      return redirect(dest, 'STATUS = OPEN');
    }

    if (status === 'FULL' || status === 'CLOSED' || status === null) {
      // FULL/CLOSED treated the same → Waitlist; fall back to Overflow → default
      const dest = (waitlist && waitlist.PUBLIC_LINK) || (overflow && overflow.PUBLIC_LINK) || ABSOLUTE_DEFAULT_URL;
      return redirect(dest, `STATUS = ${status || 'UNKNOWN'} (treated as FULL)`);
    }

    // Shouldn't reach here, but just in case:
    warn(`Unhandled STATUS "${audit.STATUS}" → using ABSOLUTE_DEFAULT_URL.`);
    return redirect(ABSOLUTE_DEFAULT_URL, 'Unhandled STATUS');
  } catch (err) {
    error('CSV fetch/parse failed; using ABSOLUTE_DEFAULT_URL.', err);
    return redirect(ABSOLUTE_DEFAULT_URL, 'CSV error');
  }
})();

// ---------- helpers ----------
function normalizeStatus(s) {
  if (!s) return null;
  const k = String(s).toUpperCase().trim();
  if (k === 'OPEN') return 'OPEN';
  if (k === 'FULL' || k === 'CLOSED') return 'FULL'; // CLOSED same as FULL per requirements
  return null;
}

function getUrlParamOverride() {
  const p = new URLSearchParams(location.search).get('override');
  if (!p) return null;
  const k = p.toUpperCase().trim();
  if (['OPEN', 'FULL', 'CLOSED'].includes(k)) {
    log(`Found URL override: ${k}`);
    return k === 'CLOSED' ? 'FULL' : k; // treat CLOSED like FULL
  }
  warn(`Invalid override "${p}" ignored.`);
  return null;
}

async function resolveDestination(effectiveStatus) {
  // Minimal CSV read to map OPEN vs FULL when using URL overrides
  const rows = await fetchCsv(CSV_URL);
  const table = indexBySection(rows);
  const audit = table[ROWS.AUDIT];
  const waitlist = table[ROWS.WAITLIST];
  const overflow = table[ROWS.OVERFLOW];

  if (effectiveStatus === 'OPEN') {
    return (audit && audit.PUBLIC_LINK) || ABSOLUTE_DEFAULT_URL;
  } else { // FULL/CLOSED
    return (waitlist && waitlist.PUBLIC_LINK) || (overflow && overflow.PUBLIC_LINK) || ABSOLUTE_DEFAULT_URL;
  }
}

async function fetchCsv(url) {
  log('Fetching CSV…');
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  return parseCsvToObjects(text);
}

function parseCsvToObjects(csvText) {
  const rows = parseCsv(csvText); // array of arrays
  if (!rows.length) return [];
  const headers = rows[0].map(h => (h || '').trim());
  return rows.slice(1).filter(r => r.length && r.some(Boolean)).map(r => {
    const obj = {};
    headers.forEach((h, i) => obj[h] = (r[i] || '').toString().trim());
    return obj;
  });
}

function indexBySection(objs) {
  const out = {};
  for (const o of objs) {
    const name = (o.SECTION || '').trim();
    if (name) out[name] = o;
  }
  return out;
}

function parseCsv(str) {
  const out = [];
  let row = [], cell = '', inQuotes = false;
  for (let i = 0; i < str.length; i++) {
    const ch = str[i], next = str[i+1];
    if (ch === '"' && inQuotes && next === '"') { cell += '"'; i++; continue; }
    if (ch === '"') { inQuotes = !inQuotes; continue; }
    if (ch === ',' && !inQuotes) { row.push(cell); cell = ''; continue; }
    if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (cell !== '' || row.length) { row.push(cell); cell = ''; out.push(row); row = []; }
      continue;
    }
    cell += ch;
  }
  if (cell !== '' || row.length) { row.push(cell); out.push(row); }
  return out;
}

function redirect(url, reason) {
  log(`Redirecting to: ${url} [${reason}]`);
  const a = document.getElementById('fallbackLink');
  if (a) a.href = url;
  window.location.replace(url);
}

function log(...a){ try{ console.log('[Redirect]', ...a);}catch{} }
function warn(...a){ try{ console.warn('[Redirect]', ...a);}catch{} }
function error(...a){ try{ console.error('[Redirect]', ...a);}catch{} }
</script>
</body>
</html>
